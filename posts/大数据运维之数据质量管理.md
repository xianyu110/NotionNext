---
title: "å¤§æ•°æ®è¿ç»´ä¹‹æ•°æ®è´¨é‡ç®¡ç†"
date: "2026-01-02T16:02:08.609871"
category: "å¤§æ•°æ®é¡¹ç›®"
tags: ["#å¤§æ•°æ®", "#è¿ç»´", "#æ•°æ®åº“"]
summary: ""author: xianyu120
status: "Published"
---

> ğŸ‰è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ Azkaban è°ƒåº¦æ•°æ®è´¨é‡ç›‘æ§æµç¨‹ï¼ŒåŒ…æ‹¬åˆ›å»ºè°ƒåº¦è„šæœ¬ã€é…ç½®å·¥ä½œæµç­‰å†…å®¹ã€‚æ–‡ç« è¿˜æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ï¼ŒåŒ…æ‹¬åˆ›å»º
> Python è„šæœ¬ã€é…ç½®Azkaban å·¥ä½œæµç­‰æ­¥éª¤ã€‚

## ç¬¬1ç«  æ•°æ®è´¨é‡ç®¡ç†æ¦‚è¿°

### 1.1 æ•°æ®è´¨é‡ç®¡ç†å®šä¹‰

æ•°æ®è´¨é‡ç®¡ç†ï¼ˆData Quality
Managementï¼‰ï¼Œæ˜¯æŒ‡å¯¹[æ•°æ®](https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE/5947370)ä»è®¡åˆ’ã€è·å–ã€å­˜å‚¨ã€å…±äº«ã€ç»´æŠ¤ã€åº”ç”¨ã€æ¶ˆäº¡ç”Ÿå‘½å‘¨æœŸçš„æ¯ä¸ªé˜¶æ®µé‡Œå¯èƒ½å¼•å‘çš„å„ç±»æ•°æ®è´¨é‡é—®é¢˜ï¼Œè¿›è¡Œè¯†åˆ«ã€åº¦é‡ã€ç›‘æ§ã€é¢„è­¦ç­‰ä¸€ç³»åˆ—ç®¡ç†æ´»åŠ¨ï¼Œå¹¶é€šè¿‡æ”¹å–„å’Œæé«˜ç»„ç»‡çš„ç®¡ç†æ°´å¹³ä½¿å¾—[æ•°æ®è´¨é‡](https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E8%B4%A8%E9%87%8F/5134536)è·å¾—è¿›ä¸€æ­¥æé«˜ã€‚

æ•°æ®è´¨é‡ç®¡ç†æ˜¯å¾ªç¯ç®¡ç†è¿‡ç¨‹ï¼Œå…¶ç»ˆæç›®æ ‡æ˜¯é€šè¿‡å¯é çš„æ•°æ®æå‡æ•°æ®åœ¨ä½¿ç”¨ä¸­çš„ä»·å€¼ï¼Œå¹¶æœ€ç»ˆä¸ºä¼ä¸šèµ¢å¾—ç»æµæ•ˆç›Šã€‚

### 1.2 æ•°æ®è´¨é‡è¯„ä»·æŒ‡æ ‡

æ•°æ®è´¨é‡ç®¡ç†çš„æœ€ç»ˆç›®æ ‡æ˜¯æ”¹å–„ï¼Œä»»ä½•æ”¹å–„éƒ½æ˜¯å»ºç«‹åœ¨è¯„ä»·çš„åŸºç¡€ä¸Šã€‚é€šå¸¸[æ•°æ®è´¨é‡](https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E8%B4%A8%E9%87%8F/5134536)çš„è¯„ä»·æ ‡å‡†åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ã€‚

_è¯„ä»·æ ‡å‡†_|  _æè¿°_|  _ç›‘æ§é¡¹_  
---|---|---  
 _å”¯ä¸€æ€§_|  æŒ‡ä¸»é”®ä¿æŒå”¯ä¸€| å­—æ®µå”¯ä¸€æ€§æ£€æŸ¥  
 _å®Œæ•´æ€§_|  ä¸»è¦åŒ…æ‹¬è®°å½•ç¼ºå¤±å’Œå­—æ®µå€¼ç¼ºå¤±ç­‰æ–¹é¢| å­—æ®µæšä¸¾å€¼æ£€æŸ¥  
å­—æ®µè®°å½•æ•°æ£€æŸ¥| |   
å­—æ®µç©ºå€¼æ£€æŸ¥| |   
 _ç²¾ç¡®åº¦_|  æ•°æ®ç”Ÿæˆçš„æ­£ç¡®æ€§ï¼Œæ•°æ®åœ¨æ•´ä¸ªé“¾è·¯æµè½¬çš„æ­£ç¡®æ€§| æ³¢åŠ¨é˜€å€¼æ£€æŸ¥  
 _åˆæ³•æ€§_|  ä¸»è¦åŒ…æ‹¬æ ¼å¼ã€ç±»å‹ã€åŸŸå€¼çš„åˆæ³•æ€§| å­—æ®µæ—¥æœŸæ ¼å¼æ£€æŸ¥  
å­—æ®µé•¿åº¦æ£€æŸ¥| |   
å­—æ®µå€¼åŸŸæ£€æŸ¥| |   
 _æ—¶æ•ˆæ€§_|  ä¸»è¦åŒ…æ‹¬æ•°æ®å¤„ç†çš„æ—¶æ•ˆæ€§| æ‰¹å¤„ç†æ˜¯å¦æŒ‰æ—¶å®Œæˆ  
  
## ç¬¬2ç«  æ•°æ®è´¨é‡ç®¡ç†å®æ“

### 2.1 éœ€æ±‚åˆ†æ

æˆ‘ä»¬çš„æ•°ä»“é¡¹ç›®ä¸»è¦ç›‘æ§ä»¥ä¸‹æ•°æ®çš„æŒ‡æ ‡ï¼š

ODSå±‚æ•°æ®é‡ï¼Œæ¯æ—¥ç¯æ¯”å’Œæ¯å‘¨åŒæ¯”å˜åŒ–ä¸èƒ½è¶…è¿‡ä¸€å®šèŒƒå›´

DIMå±‚ä¸èƒ½å‡ºç°idç©ºå€¼ï¼Œé‡å¤å€¼ï¼›

DWDå±‚ä¸èƒ½å‡ºç°idç©ºå€¼ï¼Œé‡å¤å€¼ï¼›

åœ¨æ¯å±‚ä¸­ä»»æ„æŒ‘é€‰ä¸€å¼ è¡¨ä½œä¸ºç¤ºä¾‹ã€‚

_è¡¨_|  _æ£€æŸ¥é¡¹ç›®_|  _ä¾æ®_|  _å¼‚å¸¸å€¼ä¸‹é™_|  _å¼‚å¸¸å€¼ä¸Šé™_  
---|---|---|---|---  
 _ods_order_info_|  åŒæ¯”å¢é•¿| æ•°æ®æ€»é‡| -10%| 10%  
ç¯æ¯”å¢é•¿| æ•°æ®æ€»é‡| -10%| 50%|  
å€¼åŸŸæ£€æŸ¥| final_amount| 0| 100|  
 _dwd_order_info_|  ç©ºå€¼æ£€æŸ¥| id| 0| 10  
é‡å¤å€¼æ£€æŸ¥| id| 0| 5|  
 _dim_user_info_|  ç©ºå€¼æ£€æŸ¥| id| 0| 10  
é‡å¤å€¼æ£€æŸ¥| id| 0| 5|  
  
### 2.2 åŠŸèƒ½æ¨¡å—

![img](https://i-blog.csdnimg.cn/blog_migrate/b2ac5efd42bfbc2a0563e0846adfde03.png)

### 2.3 å¼€å‘ç¯å¢ƒå‡†å¤‡

#### 2.3.1 Pythonå¼€å‘ç¯å¢ƒå‡†å¤‡

æœ¬æ–‡ä½¿ç”¨Pythonå’ŒShellè„šæœ¬å®ç°æ•°æ®è´¨é‡ç›‘æ§çš„å„é¡¹åŠŸèƒ½ï¼Œæ•…éœ€å…ˆæ­å»ºç›¸åº”çš„å¼€å‘ç¯å¢ƒï¼ŒPythonå¼€å‘å¯é€‰æ‹©IDEAï¼ˆéœ€å®‰è£…Pythonæ’ä»¶ï¼‰ï¼Œæˆ–PyCharmç­‰å·¥å…·ï¼Œæœ¬æ–‡ä½¿ç”¨IDEAä½œä¸ºå¼€å‘å·¥å…·ã€‚

_1._ _å®‰è£…Pythonæ’ä»¶_

ï¼ˆ1ï¼‰åœ¨IDEAä¸­ç‚¹å‡»â€œFileâ€ï¼Œåœ¨ä¸‹æ‹‰é€‰æ‹©ä¸­ç‚¹å‡»â€œSettingsâ€¦â€

![img](https://i-blog.csdnimg.cn/blog_migrate/82242cf5075945e961cb10fdd65b0cc3.jpeg)

ï¼ˆ2ï¼‰ç‚¹å‡»â€œPluginsâ€ï¼Œç‚¹å‡»å³ä¸Šè§’çš„â€œMarketplaceâ€ï¼Œç„¶ååœ¨æœç´¢æ¡†ä¸­è¾“å…¥â€œpythonâ€ï¼Œåœ¨æœç´¢ç»“æœåˆ—è¡¨ä¸­æ‰¾åˆ°Pythonæ’ä»¶ï¼Œç‚¹å‡»â€œInstallâ€ï¼Œå®‰è£…æ’ä»¶ã€‚

![img](https://i-blog.csdnimg.cn/blog_migrate/2b308462abff0809f874af4793f45135.jpeg)

_2._ _æ–°å»ºä¸€ä¸ªPythoné¡¹ç›®_

ï¼ˆ1ï¼‰ç‚¹å‡»Ideaä¸­çš„â€œFileâ€ï¼Œåœ¨ä¸‹åˆ—åˆ—è¡¨ä¸­ç‚¹å‡»â€œNewâ€ï¼Œåœ¨å³ä¾§å¼¹å‡ºçš„åˆ—è¡¨ä¸­ç‚¹å‡»â€œProjectâ€¦â€

![img](https://i-blog.csdnimg.cn/blog_migrate/f9dfebe1b3159276f8cccd1974b4c822.jpeg)

ï¼ˆ2ï¼‰åœ¨æ–°å»ºçš„å·¥ç¨‹ä¸­ï¼Œç‚¹å‡»â€œPythonâ€ï¼Œç„¶åç‚¹å‡»Next

![img](https://i-blog.csdnimg.cn/blog_migrate/7da9052b299f7600536ec2edeb4a807f.jpeg)

ï¼ˆ3ï¼‰é¦–æ¬¡åˆ›å»ºPythoné¡¹ç›®ï¼Œä¼šæç¤ºæ— Python SDKï¼Œæ­¤å¤„é€‰æ‹©Yesï¼Œåç»­å†æ·»åŠ SDKã€‚

![img](https://i-blog.csdnimg.cn/blog_migrate/7235eb9531864ad95e59ee285ac41a47.jpeg)

ï¼ˆ4ï¼‰å¡«å†™é¡¹ç›®åç§°å’Œé¡¹ç›®è·¯å¾„ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œç‚¹å‡»Finish

![img](https://i-blog.csdnimg.cn/blog_migrate/e5d43fe289239010a4da96adc0a5db96.jpeg)

ï¼ˆ5ï¼‰æ·»åŠ Python SDK

ä¸ºäº†ä¿è¯æµ‹è¯•å’Œè¿è¡Œçš„Pythonç¯å¢ƒä¸€è‡´ï¼Œæˆ‘ä»¬é…ç½®é¡¹ç›®é‡‡ç”¨è¿œç¨‹é›†ç¾¤çš„Pythonç¯å¢ƒæ‰§è¡Œæœ¬åœ°ä»£ç ï¼Œä»¥ä¸‹ä¸ºå…·ä½“é…ç½®æ­¥éª¤ã€‚

ç¬¬ä¸€æ­¥ï¼šç‚¹å‡»â€œFileâ€â†’â€œProject Structureâ€

![img](https://i-blog.csdnimg.cn/blog_migrate/ba506c46df832253a0d43ad002bdeca4.jpeg)

ç¬¬äºŒæ­¥ï¼šæŒ‰ç…§ä¸‹å›¾æ“ä½œï¼Œå¢åŠ Python SDKã€‚

![img](https://i-blog.csdnimg.cn/blog_migrate/f1cc3fd2416fca6f630458c88b5b2726.jpeg)

ç¬¬ä¸‰æ­¥ï¼šç‚¹å‡»â€œSSH Interpreterâ€ï¼Œé€‰æ‹©â€œExisting server configurationâ€ï¼Œç‚¹å‡»â€œâ€¦â€

![img](https://i-blog.csdnimg.cn/blog_migrate/a730676817ce81e78c5ce3336271ec85.jpeg)

ç¬¬å››æ­¥ï¼šç‚¹å‡»â€œ+â€ï¼Œå¡«å…¥sshè¿æ¥ä¿¡æ¯ï¼Œç‚¹å‡»Next

![img](https://i-blog.csdnimg.cn/blog_migrate/07274c50c9d055c0ebcdbbf0dcce9c13.jpeg)

ç¬¬äº”æ­¥ï¼šç‚¹å‡»Finish

![img](https://i-blog.csdnimg.cn/blog_migrate/cebc1463d846c7d63d0f4d9a1ad67e62.jpeg)

ç¬¬å…­æ­¥ï¼šç‚¹å‡»OK

![img](https://i-blog.csdnimg.cn/blog_migrate/e04051d68e4b402e208f1cd0ed8fcff8.jpeg)

#### 2.3.2 åˆå§‹åŒ–MySQLç¯å¢ƒ

MySQLä¸»è¦ç”¨äºå­˜å‚¨æ•°æ®è´¨é‡ç›‘æ§çš„ç»“æœå€¼ï¼Œè¿™é‡Œéœ€è¦æå‰å»ºåº“å»ºè¡¨ã€‚è¯¦ç»†å»ºè¡¨è¯­å¥å¦‚ä¸‹ï¼š

ï¼ˆ1ï¼‰åˆ›å»ºdata_supervisoråº“

drop database if exists data_supervisor;

create database data_supervisor;

ï¼ˆ2ï¼‰åˆ›å»ºç©ºå€¼æŒ‡æ ‡è¡¨ï¼Œnull_id

CREATE TABLE data_supervisor.`null_id`

(

`dt` date NOT NULL COMMENT â€˜æ—¥æœŸâ€™,

`tbl` varchar(50) NOT NULL COMMENT â€˜è¡¨åâ€™,

`col` varchar(50) NOT NULL COMMENT â€˜åˆ—åâ€™,

`value` int DEFAULT NULL COMMENT â€˜ç©ºIDä¸ªæ•°â€™,

`value_min` int DEFAULT NULL COMMENT â€˜ä¸‹é™â€™,

`value_max` int DEFAULT NULL COMMENT â€˜ä¸Šé™â€™,

`notification_level` int DEFAULT NULL COMMENT â€˜è­¦å‘Šçº§åˆ«â€™,

PRIMARY KEY (`dt`, `tbl`, `col`)

) ENGINE = InnoDB

DEFAULT CHARSET = utf8

comment â€˜ç©ºå€¼æŒ‡æ ‡è¡¨â€™;

ï¼ˆ3ï¼‰åˆ›å»ºé‡å¤å€¼æŒ‡æ ‡è¡¨ï¼Œduplicate

CREATE TABLE data_supervisor.`duplicate`

(

`dt` date NOT NULL COMMENT â€˜æ—¥æœŸâ€™,

`tbl` varchar(50) NOT NULL COMMENT â€˜è¡¨åâ€™,

`col` varchar(50) NOT NULL COMMENT â€˜åˆ—åâ€™,

`value` int DEFAULT NULL COMMENT â€˜é‡å¤å€¼ä¸ªæ•°â€™,

`value_min` int DEFAULT NULL COMMENT â€˜ä¸‹é™â€™,

`value_max` int DEFAULT NULL COMMENT â€˜ä¸Šé™â€™,

`notification_level` int DEFAULT NULL COMMENT â€˜è­¦å‘Šçº§åˆ«â€™,

PRIMARY KEY (`dt`, `tbl`, `col`)

) ENGINE = InnoDB

DEFAULT CHARSET = utf8

comment â€˜é‡å¤å€¼æŒ‡æ ‡è¡¨â€™;

ï¼ˆ4ï¼‰åˆ›å»ºå€¼åŸŸæŒ‡æ ‡è¡¨ï¼Œrng

CREATE TABLE data_supervisor.`rng`

(

`dt` date NOT NULL COMMENT â€˜æ—¥æœŸâ€™,

`tbl` varchar(50) NOT NULL COMMENT â€˜è¡¨åâ€™,

`col` varchar(50) NOT NULL COMMENT â€˜åˆ—åâ€™,

`value` int DEFAULT NULL COMMENT â€˜è¶…å‡ºé¢„å®šå€¼åŸŸä¸ªæ•°â€™,

`range_min` int DEFAULT NULL COMMENT â€˜å€¼åŸŸä¸‹é™â€™,

`range_max` int DEFAULT NULL COMMENT â€˜å€¼åŸŸä¸Šé™â€™,

`value_min` int DEFAULT NULL COMMENT â€˜ä¸‹é™â€™,

`value_max` int DEFAULT NULL COMMENT â€˜ä¸Šé™â€™,

`notification_level` int DEFAULT NULL COMMENT â€˜è­¦å‘Šçº§åˆ«â€™,

PRIMARY KEY (`dt`, `tbl`, `col`)

) ENGINE = InnoDB

DEFAULT CHARSET = utf8

comment â€˜å€¼åŸŸæŒ‡æ ‡è¡¨â€™;

ï¼ˆ5ï¼‰åˆ›å»ºç¯æ¯”å¢é•¿æŒ‡æ ‡è¡¨ï¼Œday_on_day

CREATE TABLE data_supervisor.`day_on_day`

(

`dt` date NOT NULL COMMENT â€˜æ—¥æœŸâ€™,

`tbl` varchar(50) NOT NULL COMMENT â€˜è¡¨åâ€™,

`value` double DEFAULT NULL COMMENT â€˜ç¯æ¯”å¢é•¿ç™¾åˆ†æ¯”â€™,

`value_min` double DEFAULT NULL COMMENT â€˜å¢é•¿ä¸Šé™â€™,

`value_max` double DEFAULT NULL COMMENT â€˜å¢é•¿ä¸Šé™â€™,

`notification_level` int DEFAULT NULL COMMENT â€˜è­¦å‘Šçº§åˆ«â€™,

PRIMARY KEY (`dt`, `tbl`)

) ENGINE = InnoDB

DEFAULT CHARSET = utf8

comment â€˜ç¯æ¯”å¢é•¿æŒ‡æ ‡è¡¨â€™;

ï¼ˆ6ï¼‰åˆ›å»ºåŒæ¯”å¢é•¿æŒ‡æ ‡è¡¨ï¼Œweek_on_week

CREATE TABLE data_supervisor.`week_on_week`

(

`dt` date NOT NULL COMMENT â€˜æ—¥æœŸâ€™,

`tbl` varchar(50) NOT NULL COMMENT â€˜è¡¨åâ€™,

`value` double DEFAULT NULL COMMENT â€˜åŒæ¯”å¢é•¿ç™¾åˆ†æ¯”â€™,

`value_min` double DEFAULT NULL COMMENT â€˜å¢é•¿ä¸Šé™â€™,

`value_max` double DEFAULT NULL COMMENT â€˜å¢é•¿ä¸Šé™â€™,

`notification_level` int DEFAULT NULL COMMENT â€˜è­¦å‘Šçº§åˆ«â€™,

PRIMARY KEY (`dt`, `tbl`)

) ENGINE = InnoDB

DEFAULT CHARSET = utf8

comment â€˜åŒæ¯”å¢é•¿æŒ‡æ ‡è¡¨â€™;

### 2.4 è§„åˆ™æ£€æµ‹æ¨¡å—

#### 2.4.1 å•ä¸€è§„åˆ™æ£€æµ‹è„šæœ¬ç¼–å†™

æ£€æµ‹è§„åˆ™è„šæœ¬åˆ†ä¸ºäº”ç±»ï¼šåˆ†åˆ«æ˜¯ç©ºidæ£€æŸ¥è„šæœ¬ã€é‡å¤idæ£€æŸ¥è„šæœ¬ã€å€¼åŸŸæ£€æŸ¥è„šæœ¬ã€æ•°æ®é‡ç¯æ¯”æ£€æŸ¥è„šæœ¬å’Œæ•°æ®é‡åŒæ¯”æ£€æŸ¥è„šæœ¬ã€‚

ä¸‹é¢åˆ†åˆ«ç»™å¤§å®¶ä»‹ç»ä¸€ä¸‹äº”ç±»æ£€æµ‹è„šæœ¬çš„å…·ä½“ç¼–å†™ã€‚

_1.ç©ºidæ£€æŸ¥è„šæœ¬_

åœ¨Ideaä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶null_id.shï¼Œåœ¨æ–‡ä»¶ä¸­ç¼–å†™å¦‚ä¸‹å†…å®¹ï¼š

å®ç°çš„ä¸»è¦åŠŸèƒ½æ˜¯ï¼šè®¡ç®—ç©ºå€¼ä¸ªæ•°ï¼Œå¹¶å°†ç»“æœå’Œè‡ªå·±å®šä¹‰çš„é˜ˆå€¼ä¸Šä¸‹é™ï¼Œæ’å…¥åˆ°MySQLè¡¨ä¸­ã€‚

    
    
    #!/usr/bin/env bash
    # -*- coding: utf-8 -*-
    # æ£€æŸ¥idç©ºå€¼
    # è§£æå‚æ•°
    while getopts "t:d:c:s:x:l:" arg; do
      case $arg in
      # è¦å¤„ç†çš„è¡¨å
      t)
        TABLE=$OPTARG
        ;;
      # æ—¥æœŸ
      d)
        DT=$OPTARG
        ;;
      # è¦è®¡ç®—ç©ºå€¼çš„åˆ—å
      c)
        COL=$OPTARG
        ;;
      # ç©ºå€¼æŒ‡æ ‡ä¸‹é™
      s)
        MIN=$OPTARG
        ;;
      # ç©ºå€¼æŒ‡æ ‡ä¸Šé™
      x)
        MAX=$OPTARG
        ;;
      # å‘Šè­¦çº§åˆ«
      l)
        LEVEL=$OPTARG
        ;;
      ?)
        echo "unkonw argument"
        exit 1
        ;;
      esac
    done
    

#å¦‚æœdtå’Œlevelæ²¡æœ‰è®¾ç½®ï¼Œé‚£ä¹ˆé»˜è®¤å€¼dtæ˜¯æ˜¨å¤© å‘Šè­¦çº§åˆ«æ˜¯0

[ " D T " ] âˆ£ âˆ£ D T = DT" ] || DT= DT"]âˆ£âˆ£DT=(date -d â€˜-1 dayâ€™ +%F)

[ â€œ$LEVELâ€ ] || LEVEL=0

# æ•°ä»“DBåç§°

HIVE_DB=gmall

# æŸ¥è¯¢å¼•æ“

HIVE_ENGINE=hive

# MySQLç›¸å…³é…ç½®

mysql_user=â€œrootâ€

mysql_passwd=â€œ000000â€

mysql_host=â€œhadoop102â€

mysql_DB=â€œdata_supervisorâ€

mysql_tbl=â€œnull_idâ€

# è®¤è¯ä¸ºhiveç”¨æˆ·ï¼Œå¦‚åœ¨éå®‰å…¨(Hadoopæœªå¯ç”¨Kerberosè®¤è¯)ç¯å¢ƒä¸­ï¼Œåˆ™æ— éœ€è®¤è¯

kinit -kt /etc/security/keytab/hive.keytab hive

# ç©ºå€¼ä¸ªæ•°

RESULT= ( ( (HIVE_ENGINE -e â€œset hive.cli.print.header=false;select count(1)
from  H I V E D B . HIVE_DB. HIVEDâ€‹B.TABLE where dt=â€˜$DTâ€™ and $COL is null;â€)

#ç»“æœæ’å…¥MySQL

mysql -h" m y s q l h o s t " âˆ’ u " mysql_host" -u" mysqlhâ€‹ost"âˆ’u"mysql_user"
-p"$mysql_passwd" \

-e"INSERT INTO  m y s q l D B . mysql_DB. mysqlDâ€‹B.mysql_tbl VALUES(â€˜ D T â€² , â€² DT', ' DTâ€²,â€²TABLEâ€™, â€˜$COLâ€™, $RESULT, $MIN, $MAX, $LEVEL)

ON DUPLICATE KEY UPDATE `value`= R E S U L T , v a l u e m i n = RESULT,
value_min= RESULT,valuemâ€‹in=MIN, value_max= M A X , n o t i f i c a t i o n l
e v e l = MAX, notification_level= MAX,notificationlâ€‹evel=LEVEL;"

_2.é‡å¤idæ£€æŸ¥è„šæœ¬_

åœ¨Ideaä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶duplicate.shï¼Œåœ¨æ–‡ä»¶ä¸­ç¼–å†™å¦‚ä¸‹å†…å®¹ï¼š

å®ç°çš„ä¸»è¦åŠŸèƒ½æ˜¯ï¼šè®¡ç®—é‡å¤å€¼ä¸ªæ•°ï¼Œå¹¶å°†ç»“æœå’Œè‡ªå·±å®šä¹‰çš„é˜ˆå€¼ä¸Šä¸‹é™ï¼Œæ’å…¥åˆ°MySQLè¡¨ä¸­ã€‚

    
    
    #!/usr/bin/env bash
    # -*- coding: utf-8 -*-
    # ç›‘æ§æŸå¼ è¡¨ä¸€åˆ—çš„é‡å¤å€¼
    # å‚æ•°è§£æ
    while getopts "t:d:c:s:x:l:" arg; do
      case $arg in
      # è¦å¤„ç†çš„è¡¨å
      t)
        TABLE=$OPTARG
        ;;
      # æ—¥æœŸ
      d)
        DT=$OPTARG
        ;;
      # è¦è®¡ç®—é‡å¤å€¼çš„åˆ—å
      c)
        COL=$OPTARG
        ;;
        # é‡å¤å€¼æŒ‡æ ‡ä¸‹é™
      s)
        MIN=$OPTARG
        ;;
      # é‡å¤å€¼æŒ‡æ ‡ä¸Šé™
      x)
        MAX=$OPTARG
        ;;
      # å‘Šè­¦çº§åˆ«
      l)
        LEVEL=$OPTARG
        ;;
      ?)
        echo "unkonw argument"
        exit 1
        ;;
      esac
    done
    
    #å¦‚æœdtå’Œlevelæ²¡æœ‰è®¾ç½®ï¼Œé‚£ä¹ˆé»˜è®¤å€¼dtæ˜¯æ˜¨å¤© å‘Šè­¦çº§åˆ«æ˜¯0
    [ "$DT" ] || DT=$(date -d '-1 day' +%F)
    [ "$LEVEL" ] || LEVEL=0
    
    # æ•°ä»“DBåç§°
    HIVE_DB=gmall
    
    # æŸ¥è¯¢å¼•æ“
    HIVE_ENGINE=hive
    
    # MySQLç›¸å…³é…ç½®
    mysql_user="root"
    mysql_passwd="000000"
    mysql_host="hadoop102"
    mysql_DB="data_supervisor"
    mysql_tbl="duplicate"
    
    # è®¤è¯ä¸ºhiveç”¨æˆ·ï¼Œå¦‚åœ¨éå®‰å…¨(Hadoopæœªå¯ç”¨Kerberosè®¤è¯)ç¯å¢ƒä¸­ï¼Œåˆ™æ— éœ€è®¤è¯
    kinit -kt /etc/security/keytab/hive.keytab hive
    
    # é‡å¤å€¼ä¸ªæ•°
    RESULT=$($HIVE_ENGINE -e "set hive.cli.print.header=false;select count(1) from (select $COL from $HIVE_DB.$TABLE where dt='$DT' group by $COL having count($COL)>1) t1;")
    
    # å°†ç»“æœæ’å…¥MySQL
    mysql -h"$mysql_host" -u"$mysql_user" -p"$mysql_passwd" \
      -e"INSERT INTO $mysql_DB.$mysql_tbl VALUES('$DT', '$TABLE', '$COL', $RESULT, $MIN, $MAX, $LEVEL)
    ON DUPLICATE KEY UPDATE \`value\`=$RESULT, value_min=$MIN, value_max=$MAX, notification_level=$LEVEL;"
    

_3._ _å€¼åŸŸæ£€æŸ¥è„šæœ¬_

åœ¨Ideaä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶range.shï¼Œåœ¨æ–‡ä»¶ä¸­ç¼–å†™å¦‚ä¸‹å†…å®¹ï¼š

å®ç°çš„ä¸»è¦åŠŸèƒ½æ˜¯ï¼šè®¡ç®—è¶…å‡ºè§„å®šå€¼åŸŸçš„å€¼çš„ä¸ªæ•°ï¼Œå¹¶å°†ç»“æœå’Œè‡ªå·±å®šä¹‰çš„é˜ˆå€¼ä¸Šä¸‹é™ï¼Œæ’å…¥åˆ°MySQLè¡¨ä¸­ã€‚

    
    
    #!/usr/bin/env bash
    # -*- coding: utf-8 -*-
    # è®¡ç®—æŸä¸€åˆ—å¼‚å¸¸å€¼ä¸ªæ•°
    
    while getopts "t:d:l:c:s:x:a:b:" arg; do
      case $arg in
      # è¦å¤„ç†çš„è¡¨å
      t)
        TABLE=$OPTARG
        ;;
      # æ—¥æ›¿
      d)
        DT=$OPTARG
        ;;
      # è¦å¤„ç†çš„åˆ—
      c)
        COL=$OPTARG
        ;;
      # ä¸åœ¨è§„å®šå€¼åŸŸçš„å€¼çš„ä¸ªæ•°ä¸‹é™
      s)
        MIN=$OPTARG
        ;;
      # ä¸åœ¨è§„å®šå€¼åŸŸçš„å€¼çš„ä¸ªæ•°ä¸Šé™
      x)
        MAX=$OPTARG
        ;;
      # å‘Šè­¦çº§åˆ«
      l)
        LEVEL=$OPTARG
        ;;
      # è§„å®šå€¼åŸŸä¸ºa-b
      a)
        RANGE_MIN=$OPTARG
        ;;
      b)
        RANGE_MAX=$OPTARG
        ;;
      ?)
        echo "unkonw argument"
        exit 1
        ;;
      esac
    done
    
    #å¦‚æœdtå’Œlevelæ²¡æœ‰è®¾ç½®ï¼Œé‚£ä¹ˆé»˜è®¤å€¼dtæ˜¯æ˜¨å¤© å‘Šè­¦çº§åˆ«æ˜¯0
    [ "$DT" ] || DT=$(date -d '-1 day' +%F)
    [ "$LEVEL" ] || LEVEL=0
    
    # æ•°ä»“DBåç§°
    HIVE_DB=gmall
    
    # æŸ¥è¯¢å¼•æ“
    HIVE_ENGINE=hive
    

_4._ _æ•°æ®é‡ç¯æ¯”æ£€æŸ¥è„šæœ¬_

åœ¨Ideaä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶day_on_day.shï¼Œåœ¨æ–‡ä»¶ä¸­ç¼–å†™å¦‚ä¸‹å†…å®¹ï¼š

å®ç°çš„ä¸»è¦åŠŸèƒ½æ˜¯ï¼šè®¡ç®—æ•°æ®é‡ç¯æ¯”å¢é•¿å€¼ï¼Œå¹¶å°†ç»“æœå’Œè‡ªå·±å®šä¹‰çš„é˜ˆå€¼ä¸Šä¸‹é™ï¼Œæ’å…¥åˆ°MySQLè¡¨ä¸­ã€‚

    
    
    #!/usr/bin/env bash
    # -*- coding: utf-8 -*-
    # è®¡ç®—ä¸€å¼ è¡¨å•æ—¥æ•°æ®é‡ç¯æ¯”å¢é•¿å€¼
    # å‚æ•°è§£æ
    while getopts "t:d:s:x:l:" arg; do
      case $arg in
      # è¦å¤„ç†çš„è¡¨å
      t)
        TABLE=$OPTARG
        ;;
      # æ—¥æœŸ
      d)
        DT=$OPTARG
        ;;
      # ç¯æ¯”å¢é•¿æŒ‡æ ‡ä¸‹é™
      s)
        MIN=$OPTARG
        ;;
      # ç¯æ¯”å¢é•¿æŒ‡æ ‡ä¸Šé™
      x)
        MAX=$OPTARG
        ;;
      # å‘Šè­¦çº§åˆ«
      l)
        LEVEL=$OPTARG
        ;;
      ?)
        echo "unkonw argument"
        exit 1
        ;;
      esac
    done
    
    #å¦‚æœdtå’Œlevelæ²¡æœ‰è®¾ç½®ï¼Œé‚£ä¹ˆé»˜è®¤å€¼dtæ˜¯æ˜¨å¤© å‘Šè­¦çº§åˆ«æ˜¯0
    [ "$DT" ] || DT=$(date -d '-1 day' +%F)
    [ "$LEVEL" ] || LEVEL=0
    
    # æ•°ä»“DBåç§°
    HIVE_DB=gmall
    
    # æŸ¥è¯¢å¼•æ“
    HIVE_ENGINE=hive
    
    # MySQLç›¸å…³é…ç½®
    mysql_user="root"
    mysql_passwd="000000"
    mysql_host="hadoop102"
    mysql_DB="data_supervisor"
    mysql_tbl="day_on_day"
    
    # è®¤è¯ä¸ºhiveç”¨æˆ·ï¼Œå¦‚åœ¨éå®‰å…¨(Hadoopæœªå¯ç”¨Kerberosè®¤è¯)ç¯å¢ƒä¸­ï¼Œåˆ™æ— éœ€è®¤è¯
    kinit -kt /etc/security/keytab/hive.keytab hive
    
    # æ˜¨æ—¥æ•°æ®é‡
    YESTERDAY=$($HIVE_ENGINE -e "set hive.cli.print.header=false; select count(1) from $HIVE_DB.$TABLE where dt=date_add('$DT',-1);")
    
    # ä»Šæ—¥æ•°æ®é‡
    TODAY=$($HIVE_ENGINE -e "set hive.cli.print.header=false;select count(1) from $HIVE_DB.$TABLE where dt='$DT';")
    
    # è®¡ç®—ç¯æ¯”å¢é•¿å€¼
    if [ "$YESTERDAY" -ne 0 ]; then
      RESULT=$(awk "BEGIN{print ($TODAY-$YESTERDAY)/$YESTERDAY*100}")
    else
      RESULT=10000
    fi
    
    # å°†ç»“æœå†™å…¥MySQLè¡¨æ ¼
    mysql -h"$mysql_host" -u"$mysql_user" -p"$mysql_passwd" \
      -e"INSERT INTO $mysql_DB.$mysql_tbl VALUES('$DT', '$TABLE', $RESULT, $MIN, $MAX, $LEVEL)
    ON DUPLICATE KEY UPDATE \`value\`=$RESULT, value_min=$MIN, value_max=$MAX, notification_level=$LEVEL;"
    

_5._ _æ•°æ®é‡åŒæ¯”æ£€æŸ¥è„šæœ¬_

åœ¨Ideaä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶week_on_week.shï¼Œåœ¨æ–‡ä»¶ä¸­ç¼–å†™å¦‚ä¸‹å†…å®¹ï¼š

å®ç°çš„ä¸»è¦åŠŸèƒ½æ˜¯ï¼šè®¡ç®—æ•°æ®é‡åŒæ¯”å¢é•¿å€¼ï¼Œå¹¶å°†ç»“æœå’Œè‡ªå·±å®šä¹‰çš„é˜ˆå€¼ä¸Šä¸‹é™ï¼Œæ’å…¥åˆ°MySQLè¡¨ä¸­ã€‚

    
    
    #!/usr/bin/env bash
    # -*- coding: utf-8 -*-
    # è®¡ç®—ä¸€å¼ è¡¨ä¸€å‘¨æ•°æ®é‡åŒæ¯”å¢é•¿å€¼
    # å‚æ•°è§£æ
    while getopts "t:d:s:x:l:" arg; do
      case $arg in
      # è¦å¤„ç†çš„è¡¨å
      t)
        TABLE=$OPTARG
        ;;
      # æ—¥æœŸ
      d)
        DT=$OPTARG
        ;;
      # åŒæ¯”å¢é•¿æŒ‡æ ‡ä¸‹é™
      s)
        MIN=$OPTARG
        ;;
      # åŒæ¯”å¢é•¿æŒ‡æ ‡ä¸Šé™
      x)
        MAX=$OPTARG
        ;;
      # å‘Šè­¦çº§åˆ«
      l)
        LEVEL=$OPTARG
        ;;
      ?)
        echo "unkonw argument"
        exit 1
        ;;
      esac
    done
    
    #å¦‚æœdtå’Œlevelæ²¡æœ‰è®¾ç½®ï¼Œé‚£ä¹ˆé»˜è®¤å€¼dtæ˜¯æ˜¨å¤© å‘Šè­¦çº§åˆ«æ˜¯0
    [ "$DT" ] || DT=$(date -d '-1 day' +%F)
    [ "$LEVEL" ] || LEVEL=0
    
    # æ•°ä»“DBåç§°
    HIVE_DB=gmall
    
    # æŸ¥è¯¢å¼•æ“
    HIVE_ENGINE=hive
    
    # MySQLç›¸å…³é…ç½®
    mysql_user="root"
    mysql_passwd="000000"
    mysql_host="hadoop102"
    mysql_DB="data_supervisor"
    mysql_tbl="week_on_week"
    
    # è®¤è¯ä¸ºhiveç”¨æˆ·ï¼Œå¦‚åœ¨éå®‰å…¨(Hadoopæœªå¯ç”¨Kerberosè®¤è¯)ç¯å¢ƒä¸­ï¼Œåˆ™æ— éœ€è®¤è¯
    kinit -kt /etc/security/keytab/hive.keytab hive
    
    # ä¸Šå‘¨æ•°æ®é‡
    LASTWEEK=$($HIVE_ENGINE -e "set hive.cli.print.header=false;select count(1) from $HIVE_DB.$TABLE where dt=date_add('$DT',-7);")
    
    # æœ¬å‘¨æ•°æ®é‡
    THISWEEK=$($HIVE_ENGINE -e "set hive.cli.print.header=false;select count(1) from $HIVE_DB.$TABLE where dt='$DT';")
    
    # è®¡ç®—å¢é•¿
    if [ $LASTWEEK -ne 0 ]; then
      RESULT=$(awk "BEGIN{print ($THISWEEK-$LASTWEEK)/$LASTWEEK*100}")
    else
      RESULT=10000
    fi
    
    # å°†ç»“æœå†™å…¥MySQL
    mysql -h"$mysql_host" -u"$mysql_user" -p"$mysql_passwd" \
      -e"INSERT INTO $mysql_DB.$mysql_tbl VALUES('$DT', '$TABLE', $RESULT, $MIN, $MAX, $LEVEL)
    ON DUPLICATE KEY UPDATE \`value\`=$RESULT, value_min=$MIN, value_max=$MAX, notification_level=$LEVEL;"
    

#### 2.4.2 æ•°ä»“å„å±‚æ£€æµ‹è„šæœ¬ç¼–å†™

å°†ä¸Šä¸€èŠ‚ç¼–å†™çš„å•ä¸€è§„åˆ™æ£€æµ‹è„šæœ¬æŒ‰ç…§æ•°ä»“åˆ†å±‚è¿›è¡Œé›†æˆï¼Œåˆ†åˆ«ç¼–å†™ODSå±‚æ£€æµ‹è„šæœ¬ï¼ŒDWDå±‚æ£€æµ‹è„šæœ¬å’ŒDIMå±‚æ£€æµ‹è„šæœ¬ã€‚

æ¯å±‚è¯¦ç»†é›†æˆæ­¥éª¤å¦‚ä¸‹

_1\. ODSå±‚_

ODSå±‚éœ€è¦æ£€æŸ¥çš„æŒ‡æ ‡å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚

_è¡¨_|  _æ£€æŸ¥é¡¹ç›®_|  _ä¾æ®_|  _å¼‚å¸¸å€¼ä¸‹é™_|  _å¼‚å¸¸å€¼ä¸Šé™_  
---|---|---|---|---  
 _ods_order_info_|  åŒæ¯”å¢é•¿| æ•°æ®æ€»é‡| -10%| 10%  
ç¯æ¯”å¢é•¿| æ•°æ®æ€»é‡| -10%| 50%|  
å€¼åŸŸæ£€æŸ¥| final_amount| 0| 100|  
  
åœ¨Ideaä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶check_ods.shï¼Œåœ¨æ–‡ä»¶ä¸­ç¼–å†™å¦‚ä¸‹å†…å®¹ï¼š

#!/usr/bin/env bash

DT=$1

[ " D T " ] âˆ£ âˆ£ D T = DT" ] || DT= DT"]âˆ£âˆ£DT=(date -d â€˜-1 dayâ€™ +%F)

#æ£€æŸ¥è¡¨ ods_order_info æ•°æ®é‡æ—¥ç¯æ¯”å¢é•¿

#å‚æ•°ï¼š -t è¡¨å

# -d æ—¥æœŸ

# -s ç¯æ¯”å¢é•¿ä¸‹é™

# -x ç¯æ¯”å¢é•¿ä¸Šé™

# -l å‘Šè­¦çº§åˆ«

bash day_on_day.sh -t ods_order_info -d â€œ$DTâ€ -s -10 -x 10 -l 1

#æ£€æŸ¥è¡¨ ods_order_info æ•°æ®é‡å‘¨åŒæ¯”å¢é•¿

#å‚æ•°ï¼š -t è¡¨å

# -d æ—¥æœŸ

# -s åŒæ¯”å¢é•¿ä¸‹é™

# -x åŒæ¯”å¢é•¿ä¸Šé™

# -l å‘Šè­¦çº§åˆ«

bash week_on_week.sh -t ods_order_info -d â€œ$DTâ€ -s -10 -x 50 -l 1

#æ£€æŸ¥è¡¨ ods_order_info è®¢å•å¼‚å¸¸å€¼

#å‚æ•°ï¼š -t è¡¨å

# -d æ—¥æœŸ

# -s æŒ‡æ ‡ä¸‹é™

# -x æŒ‡æ ‡ä¸Šé™

# -l å‘Šè­¦çº§åˆ«

# -a å€¼åŸŸä¸‹é™

# -b å€¼åŸŸä¸Šé™

bash range.sh -t ods_order_info -d â€œ$DTâ€ -c final_amount -a 0 -b 100000 -s 0
-x 100 -l 1

_2\. DWDå±‚_

DWDå±‚éœ€è¦æ£€æŸ¥çš„é¡¹ç›®ä¸‹æ ‡æ‰€ç¤ºã€‚

_è¡¨_|  _æ£€æŸ¥é¡¹ç›®_|  _ä¾æ®_|  _å¼‚å¸¸å€¼ä¸‹é™_|  _å¼‚å¸¸å€¼ä¸Šé™_  
---|---|---|---|---  
 _dwd_order_info_|  ç©ºå€¼æ£€æŸ¥| id| 0| 10  
é‡å¤å€¼æ£€æŸ¥| id| 0| 5|  
  
åœ¨Ideaä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶check_dwd.shï¼Œåœ¨æ–‡ä»¶ä¸­ç¼–å†™å¦‚ä¸‹å†…å®¹ï¼š

#!/usr/bin/env bash

DT=$1

[ " D T " ] âˆ£ âˆ£ D T = DT" ] || DT= DT"]âˆ£âˆ£DT=(date -d â€˜-1 dayâ€™ +%F)

# æ£€æŸ¥è¡¨ dwd_order_info é‡å¤ID

#å‚æ•°ï¼š -t è¡¨å

# -d æ—¥æœŸ

# -c æ£€æŸ¥é‡å¤å€¼çš„åˆ—

# -s å¼‚å¸¸æŒ‡æ ‡ä¸‹é™

# -x å¼‚å¸¸æŒ‡æ ‡ä¸Šé™

# -l å‘Šè­¦çº§åˆ«

bash duplicate.sh -t dwd_order_info -d â€œ$DTâ€ -c id -s 0 -x 5 -l 0

#æ£€æŸ¥è¡¨ dwd_order_info çš„ç©ºID

#å‚æ•°ï¼š -t è¡¨å

# -d æ—¥æœŸ

# -c æ£€æŸ¥ç©ºå€¼çš„åˆ—

# -s å¼‚å¸¸æŒ‡æ ‡ä¸‹é™

# -x å¼‚å¸¸æŒ‡æ ‡ä¸Šé™

# -l å‘Šè­¦çº§åˆ«

bash null_id.sh -t dwd_order_info -d â€œ$DTâ€ -c id -s 0 -x 10 -l 0

_3\. DIMå±‚_

DIMå±‚éœ€è¦æ£€æŸ¥çš„é¡¹ç›®å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚

_è¡¨_|  _æ£€æŸ¥é¡¹ç›®_|  _ä¾æ®_|  _å¼‚å¸¸å€¼ä¸‹é™_|  _å¼‚å¸¸å€¼ä¸Šé™_  
---|---|---|---|---  
 _dim_user_info_|  ç©ºå€¼æ£€æŸ¥| id| 0| 10  
é‡å¤å€¼æ£€æŸ¥| id| 0| 5|  
  
åœ¨Ideaä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶check_dim.shï¼Œåœ¨æ–‡ä»¶ä¸­ç¼–å†™å¦‚ä¸‹å†…å®¹ï¼š

#!/usr/bin/env bash

DT=$1

[ " D T " ] âˆ£ âˆ£ D T = DT" ] || DT= DT"]âˆ£âˆ£DT=(date -d â€˜-1 dayâ€™ +%F)

#æ£€æŸ¥è¡¨ dim_user_info çš„é‡å¤ID

#å‚æ•°ï¼š -t è¡¨å

# -d æ—¥æœŸ

# -c æ£€æŸ¥é‡å¤å€¼çš„åˆ—

# -s å¼‚å¸¸æŒ‡æ ‡ä¸‹é™

# -x å¼‚å¸¸æŒ‡æ ‡ä¸Šé™

# -l å‘Šè­¦çº§åˆ«

bash duplicate.sh -t dim_user_info -d â€œ$DTâ€ -c id -s 0 -x 5 -l 0

#æ£€æŸ¥è¡¨ dim_user_info çš„ç©ºID

#å‚æ•°ï¼š -t è¡¨å

# -d æ—¥æœŸ

# -c æ£€æŸ¥ç©ºå€¼çš„åˆ—

# -s å¼‚å¸¸æŒ‡æ ‡ä¸‹é™

# -x å¼‚å¸¸æŒ‡æ ‡ä¸Šé™

# -l å‘Šè­¦çº§åˆ«

bash null_id.sh -t dim_user_info -d â€œ$DTâ€ -c id -s 0 -x 10 -l 0

### 2.5 å‘Šè­¦é›†æˆæ¨¡å—

è¯¥æ¨¡å—ä¸»è¦ç”¨äºæ£€æŸ¥MySQLä¸­çš„æ£€æµ‹ç»“æœçš„å¼‚å¸¸ï¼Œè‹¥æœ‰å¼‚å¸¸å‡ºç°å°±å‘é€è­¦å‘Šã€‚è­¦å‘Šæ–¹å¼å¯é€‰æ‹©é‚®ä»¶æˆ–è€…é›†æˆç¬¬ä¸‰æ–¹å‘Šè­¦å¹³å°ç¿è±¡äº‘ã€‚

ï¼ˆ1ï¼‰ç¯å¢ƒå‡†å¤‡

åœ¨MySQLå®˜ç½‘ä¸‹è½½mysql-connector-python-2.1.7-1.el7.x86_64.rpmï¼Œä¸‹è½½åœ°å€å¦‚ä¸‹ï¼š

https://repo.mysql.com/yum/mysql-connectors-community/el/7/x86_64/mysql-
connector-python-2.1.7-1.el7.x86_64.rpm

å°†è¯¥rpmåŒ…ä¸Šä¼ è‡³æ¯å°æœåŠ¡å™¨ï¼Œå¹¶å®‰è£…ï¼š

[atguigu@hadoop102 ~]$ sudo rpm -i mysql-connector-
python-2.1.7-1.el7.x86_64.rpm

ï¼ˆ2ï¼‰æ–°å»ºpythonè„šæœ¬ç”¨äºæŸ¥è¯¢æ•°æ®ç›‘æ§ç»“æœè¡¨æ ¼å¹¶å‘é€å‘Šè­¦é‚®ä»¶ï¼Œè¯¥è„šæœ¬ä¸»è¦ç”±ä¸‰ä¸ªå‡½æ•°ç»„æˆï¼š

l read_tableç”¨äºè¯»å–æŒ‡æ ‡æœ‰é—®é¢˜çš„æ•°æ®

l one_alertå‡½æ•°ç”¨äºå‘ç¿è±¡äº‘å‘é€å‘Šè­¦

l mail_alertå‡½æ•°ç”¨äºå‘é€é‚®ä»¶å‘Šè­¦

åœ¨Ideaä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶check_notification.pyï¼Œåœ¨æ–‡ä»¶ä¸­ç¼–å†™å¦‚ä¸‹å†…å®¹ï¼š

#!/usr/bin/env python

# -_\- coding: utf-8 -_ -

import mysql.connector

import sys

import smtplib

from email.mime.text import MIMEText

from email.header import Header

import datetime

import urllib

import urllib2

import random

def get_yesterday():

â€œâ€"

:return: å‰ä¸€å¤©çš„æ—¥æœŸ

â€œâ€"

today = datetime.date.today()

one_day = datetime.timedelta(days=1)

yesterday = today - one_day

return str(yesterday)

def read_table(table, dt):

â€œâ€"

:param table:è¯»å–çš„è¡¨å

:param dt:è¯»å–çš„æ•°æ®æ—¥æœŸ

:return:è¡¨ä¸­çš„å¼‚å¸¸æ•°æ®(ç»Ÿè®¡ç»“æœè¶…å‡ºè§„å®šä¸Šä¸‹é™çš„æ•°æ®)

â€œâ€"

# mysqlå¿…è¦å‚æ•°è®¾ç½®ï¼Œéœ€æ ¹æ®å®é™…æƒ…å†µä½œå‡ºä¿®æ”¹

mysql_user = â€œrootâ€

mysql_password = â€œ000000â€

mysql_host = â€œhadoop102â€

mysql_schema = â€œdata_supervisorâ€

# è·å–Mysqlæ•°æ®åº“è¿æ¥

connect = mysql.connector.connect(user=mysql_user, password=mysql_password,
host=mysql_host, database=mysql_schema)

cursor = connect.cursor()

# æŸ¥è¯¢è¡¨å¤´

# [â€˜dtâ€™, â€˜tblâ€™, â€˜colâ€™, â€˜valueâ€™, â€˜value_minâ€™, â€˜value_maxâ€™,
â€˜notification_levelâ€™]

query = "desc " + table

cursor.execute(query)

head = map(lambda x: str(x[0]), cursor.fetchall())

# æŸ¥è¯¢å¼‚å¸¸æ•°æ®(ç»Ÿè®¡ç»“æœè¶…å‡ºè§„å®šä¸Šä¸‹é™çš„æ•°æ®)

# [(datetime.date(2021, 7, 16), uâ€™dim_user_infoâ€™, uâ€™idâ€™, 7, 0, 5, 1),

# (datetime.date(2021, 7, 16), uâ€™dwd_order_idâ€™, uâ€™idâ€™, 10, 0, 5, 1)]

query = (â€œselect * from " + table + " where dt='â€ + dt + â€œâ€™ and `value` not
between value_min and value_maxâ€)

cursor.execute(query)

cursor_fetchall = cursor.fetchall()

# å°†æŒ‡æ ‡å’Œè¡¨å¤´æ˜ å°„æˆä¸ºdictæ•°ç»„

#[{â€˜notification_levelâ€™: 1, â€˜value_minâ€™: 0, â€˜valueâ€™: 7, â€˜colâ€™: uâ€™idâ€™, â€˜tblâ€™:
uâ€™dim_user_infoâ€™, â€˜dtâ€™: datetime.date(2021, 7, 16), â€˜value_maxâ€™: 5},

# {â€˜notification_levelâ€™: 1, â€˜value_minâ€™: 0, â€˜valueâ€™: 10, â€˜colâ€™: uâ€™idâ€™, â€˜tblâ€™:
uâ€™dwd_order_idâ€™, â€˜dtâ€™: datetime.date(2021, 7, 16), â€˜value_maxâ€™: 5}]

fetchall = map(lambda x: dict(x), map(lambda x: zip(head, x),
cursor_fetchall))

return fetchall

def one_alert(line):

â€œâ€"

é›†æˆç¬¬ä¸‰æ–¹å‘Šè­¦å¹³å°ç¿è±¡äº‘ï¼Œä½¿ç”¨å…¶æä¾›çš„é€šçŸ¥åª’ä»‹å‘é€å‘Šè­¦ä¿¡æ¯

:param line: ä¸€ä¸ªç­‰å¾…é€šçŸ¥çš„å¼‚å¸¸è®°å½•ï¼Œ{â€˜notification_levelâ€™: 1, â€˜value_minâ€™: 0, â€˜valueâ€™: 7,
â€˜colâ€™: uâ€™idâ€™, â€˜tblâ€™: uâ€™dim_user_infoâ€™, â€˜dtâ€™: datetime.date(2021, 7, 16),
â€˜value_maxâ€™: 5}

â€œâ€"

# é›†æˆç¿è±¡äº‘éœ€è¦ä½¿ç”¨çš„restæ¥å£ï¼Œå’ŒAPP KEYï¼Œé¡»åœ¨ç¿è±¡äº‘å¹³å°è·å–

one_alert_key = â€œc2030c9a-7896-426f-bd64-59a8889ac8e3â€

one_alert_host = â€œhttp://api.aiops.com/alert/api/eventâ€

# æ ¹æ®ç¿è±¡äº‘çš„rest apiè¦æ±‚ï¼Œä¼ å…¥å¿…è¦çš„å‚æ•°

data = {

â€‹ â€œappâ€: one_alert_key,

â€‹ â€œeventTypeâ€: â€œtriggerâ€,

â€‹ â€œeventIdâ€: str(random.randint(10000, 99999)),

â€‹ â€œalarmNameâ€: â€œâ€.join([â€œè¡¨æ ¼â€, str(line[â€œtblâ€]), â€œæ•°æ®å¼‚å¸¸.â€]),

â€‹ â€œalarmContentâ€: â€œâ€.join([â€œæŒ‡æ ‡â€, str(line[â€œnormâ€]), â€œå€¼ä¸ºâ€, str(line[â€œvalueâ€]),

â€‹ â€œ, åº”ä¸ºâ€, str(line[â€œvalue_minâ€]), â€œ-â€, str(line[â€œvalue_maxâ€]),

â€‹ â€œ, å‚è€ƒä¿¡æ¯ï¼šâ€ + str(line[â€œcolâ€]) if line.get(â€œcolâ€) else â€œâ€]),

â€‹ â€œpriorityâ€: line[â€œnotification_levelâ€] + 1

}

# ä½¿ç”¨urllibå’Œurllib2å‘ç¿è±¡äº‘çš„restç»“æ„å‘é€è¯·æ±‚ï¼Œä»è€Œè§¦å‘ç¿è±¡äº‘çš„é€šçŸ¥ç­–ç•¥

body = urllib.urlencode(data)

request = urllib2.Request(one_alert_host, body)

urlopen = urllib2.urlopen(request).read().decode(â€˜utf-8â€™)

print urlopen

def mail_alert(line):

â€œâ€"

ä½¿ç”¨ç”µå­é‚®ä»¶çš„æ–¹å¼å‘é€å‘Šè­¦ä¿¡æ¯

:param line: ä¸€ä¸ªç­‰å¾…é€šçŸ¥çš„å¼‚å¸¸è®°å½•ï¼Œ{â€˜notification_levelâ€™: 1, â€˜value_minâ€™: 0, â€˜valueâ€™: 7,
â€˜colâ€™: uâ€™idâ€™, â€˜tblâ€™: uâ€™dim_user_infoâ€™, â€˜dtâ€™: datetime.date(2021, 7, 16),
â€˜value_maxâ€™: 5}

â€œâ€"

# smtpåè®®å‘é€é‚®ä»¶çš„å¿…è¦è®¾ç½®

mail_host = â€œsmtp.126.comâ€

mail_user = â€œskiinder@126.comâ€

mail_pass = â€œKADEMQZWCPFWZETFâ€

# å‘Šè­¦å†…å®¹

message = [â€œâ€.join([â€œè¡¨æ ¼â€, str(line[â€œtblâ€]), â€œæ•°æ®å¼‚å¸¸.â€]),

â€‹ â€œâ€.join([â€œæŒ‡æ ‡â€, str(line[â€œnormâ€]), â€œå€¼ä¸ºâ€, str(line[â€œvalueâ€]),

â€‹ â€œ, åº”ä¸ºâ€, str(line[â€œvalue_minâ€]), â€œ-â€, str(line[â€œvalue_maxâ€]),

â€‹ â€œ, å‚è€ƒä¿¡æ¯ï¼šâ€ + str(line[â€œcolâ€]) if line.get(â€œcolâ€) else â€œâ€])]

# å‘Šè­¦é‚®ä»¶ï¼Œå‘ä»¶äºº

sender = mail_user

# å‘Šè­¦é‚®ä»¶ï¼Œæ”¶ä»¶äºº

receivers = [mail_user]

# å°†é‚®ä»¶å†…å®¹è½¬ä¸ºhtmlæ ¼å¼

mail_content = MIMEText(â€œâ€.join([â€œâ€, â€œ  
â€.join(message), â€œâ€]), â€œhtmlâ€, â€œutf-8â€)

mail_content[â€œfromâ€] = sender

mail_content[â€œtoâ€] = receivers[0]

mail_content[â€œSubjectâ€] = Header(message[0], â€œutf-8â€)

# ä½¿ç”¨smtplibå‘é€é‚®ä»¶

try:

â€‹ smtp = smtplib.SMTP_SSL()

â€‹ smtp.connect(mail_host, 465)

â€‹ smtp.login(mail_user, mail_pass)

â€‹ content_as_string = mail_content.as_string()

â€‹ smtp.sendmail(sender, receivers, content_as_string)

except smtplib.SMTPException as e:

â€‹ print e

def main(argv):

â€œâ€"

:param argv: ç³»ç»Ÿå‚æ•°ï¼Œå…±ä¸‰ä¸ªï¼Œç¬¬ä¸€ä¸ªä¸ºpythonè„šæœ¬æœ¬èº«ï¼Œç¬¬äºŒä¸ªä¸ºå‘Šè­¦æ–¹å¼ï¼Œç¬¬ä¸‰ä¸ªä¸ºæ—¥æœŸ

â€œâ€"

# å¦‚æœæ²¡æœ‰ä¼ å…¥æ—¥æœŸå‚æ•°ï¼Œå°†æ—¥æœŸå®šä¸ºæ˜¨å¤©

if len(argv) >= 3:

â€‹ dt = argv[2]

else:

â€‹ dt = get_yesterday()

notification_level = 0

# é€šè¿‡å‚æ•°è®¾ç½®å‘Šè­¦æ–¹å¼ï¼Œé»˜è®¤æ˜¯ç¿è±¡äº‘

alert = None

if len(argv) >= 2:

â€‹ alert = {

â€‹ â€œmailâ€: mail_alert,

â€‹ â€œoneâ€: one_alert

â€‹ }[argv[1]]

if not alert:

â€‹ alert = one_alert

# éå†æ‰€æœ‰è¡¨ï¼ŒæŸ¥è¯¢æ‰€æœ‰é”™è¯¯å†…å®¹ï¼Œå¦‚æœå¤§äºè®¾å®šè­¦å‘Šç­‰çº§ï¼Œå°±å‘é€è­¦å‘Š

for table in [â€œday_on_dayâ€, â€œduplicateâ€, â€œnull_idâ€, â€œrngâ€, â€œweek_on_weekâ€]:

â€‹ for line in read_table(table, dt):

â€‹ if line[â€œnotification_levelâ€] >= notification_level:

â€‹ line[â€œnormâ€] = table

â€‹ alert(line)

if **name** == â€œ**main** â€:

# ä¸¤ä¸ªå‘½ä»¤è¡Œå‚æ•°

# ç¬¬ä¸€ä¸ªä¸ºè­¦å‘Šç±»å‹ï¼šoneæˆ–è€…mail

# ç¬¬äºŒä¸ªä¸ºæ—¥æœŸï¼Œç•™ç©ºå–æ˜¨å¤©

main(sys.argv)

### 2.6 è°ƒåº¦æ¨¡å—

è¯¥æ¨¡å—çš„ä¸»è¦åŠŸèƒ½ä¸ºè°ƒåº¦æ•°æ®è´¨é‡ç›‘æ§æµç¨‹ã€‚æ•°æ®è´¨é‡ç›‘æ§å·¥ä½œæµä¹Ÿé‡‡ç”¨Azkabanè¿›è¡Œè°ƒåº¦ã€‚æ•°æ®è´¨é‡ç›‘æ§å·¥ä½œæµå¿…å®šä¾èµ–æ•°æ®ä»“åº“å·¥ä½œæµï¼Œæ­¤å¤„ä¸ºäº†è§£è€¦ï¼Œåˆ©ç”¨Azkaban
APIä¸»åŠ¨ç›‘è§†æ•°æ®ä»“åº“å·¥ä½œæµçš„æ‰§è¡ŒçŠ¶æ€ï¼Œè¿›è€Œè§¦å‘æ•°æ®è´¨é‡ç›‘æ§å·¥ä½œæµã€‚

ä»¥ä¸‹æ˜¯æ‰€æœ‰è„šæœ¬å†…å®¹ï¼š

_1.Azkaban REST API_ _å°è£…è„šæœ¬_

è¯¥è„šæœ¬ä¸»è¦æ˜¯å¯¹Azkaban APIçš„å°è£…ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªæ–¹æ³•ï¼š

l loginå‡½æ•°å¯ä»¥ç™»å½•Azkanbanå¹¶è¿”å›session_id

l get_exec_idå‡½æ•°å¯ä»¥è·å–æ­£åœ¨æ‰§è¡Œçš„å·¥ä½œæµç¨‹çš„Execution ID

l wait_nodeå¯ä»¥ç­‰å¾…æŒ‡å®šFlowä¸­æŸä¸€ç»“ç‚¹æ‰§è¡Œå®Œæ¯•å¹¶åˆ¤æ–­å…¶æ˜¯å¦æ‰§è¡ŒæˆåŠŸ

åœ¨Ideaä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶azclient.pyï¼Œåœ¨æ–‡ä»¶ä¸­ç¼–å†™å¦‚ä¸‹å†…å®¹ï¼š

#!/usr/bin/env python

# -_\- coding: utf-8 -_ -

import time

import urllib

import urllib2

import json

# Azkaban API æ¥å£åœ°å€

az_url = â€œhttp://hadoop102:8081/â€

# Azkabanç”¨æˆ·å

az_username = â€œatguiguâ€

# Azkabanå¯†ç 

az_password = â€œatguiguâ€

# å·¥ç¨‹åç§°

project = â€œgmallâ€

# flowåç§°

flow = â€œgmallâ€

def post(url, data):

â€œâ€"

å‘é€postè¯·æ±‚åˆ°æŒ‡å®šç½‘å€

:param url: æŒ‡å®šç½‘å€

:param data: è¯·æ±‚å‚æ•°

:return: è¯·æ±‚ç»“æœ

â€œâ€"

body = urllib.urlencode(data)

request = urllib2.Request(url, body)

urlopen = urllib2.urlopen(request).read().decode(â€˜utf-8â€™)

return json.loads(urlopen)

def get(url, data):

â€œâ€"

å‘é€getè¯·æ±‚åˆ°æŒ‡å®šç½‘å€

:param url: æŒ‡å®šç½‘å€

:param data: è¯·æ±‚å‚æ•°

:return: è¯·æ±‚ç»“æœ

â€œâ€"

body = urllib.urlencode(data)

urlopen = urllib2.urlopen(url + body).read().decode(â€˜utf-8â€™)

return json.loads(urlopen)

def login():

â€œâ€"

ä½¿ç”¨`Authenticate`APIè¿›è¡Œazkabanèº«ä»½è®¤è¯ï¼Œè·å–session ID

:return: è¿”å›session_id

â€œâ€"

data = {

â€‹ â€œactionâ€: â€œloginâ€,

â€‹ â€œusernameâ€: az_username,

â€‹ â€œpasswordâ€: az_password

}

auth = post(az_url, data)

return str(auth.get(u"session.id"))

def get_exec_id(session_id):

â€œâ€"

ä½¿ç”¨`Fetch Running Executions of a Flow`APIè·å–æ­£åœ¨æ‰§è¡Œçš„Flowçš„ExecId

:param session_id: å’Œazkabané€šè®¯çš„session_id

:param project: é¡¹ç›®åç§°

:param flow: å·¥ä½œæµåç§°

:return: æ‰§è¡ŒID

â€œâ€"

data = {

â€‹ â€œsession.idâ€: session_id,

â€‹ â€œajaxâ€: â€œgetRunningâ€,

â€‹ â€œprojectâ€: project,

â€‹ â€œflowâ€: flow

}

execs = get(az_url + â€œexecutor?â€, data).get(u"execIds")

if execs:

â€‹ return str(execs[0])

else:

â€‹ return None

def wait_node(session_id, exec_id, node_id):

â€œâ€"

å¾ªç¯ä½¿ç”¨`Fetch a Flow Execution`APIè·å–æŒ‡å®šFlowä¸­çš„æŸä¸ªèŠ‚ç‚¹(job)çš„æ‰§è¡ŒçŠ¶æ€ï¼Œç›´åˆ°å…¶æ‰§è¡Œå®Œæˆ

:param session_id: å’Œazkabané€šè®¯çš„session_id

:param exec_id: æ‰§è¡ŒID

:param node_id: æŒ‡å®šèŠ‚ç‚¹(job)

:return: è¯¥èŠ‚ç‚¹æ˜¯å¦æˆåŠŸæ‰§è¡Œå®Œæ¯•

â€œâ€"

data = {

â€‹ â€œsession.idâ€: session_id,

â€‹ â€œajaxâ€: â€œfetchexecflowâ€,

â€‹ â€œexecidâ€: exec_id

}

status = None

# è‹¥æŒ‡å®šFlowä¸­çš„æŒ‡å®šNode(job)çš„æ‰§è¡ŒçŠ¶æ€æ˜¯æœªå®Œæˆçš„çŠ¶æ€ï¼Œå°±ä¸€ç›´å¾ªç¯

while status not in [â€œSUCCEEDEDâ€, â€œFAILEDâ€, â€œCANCELLEDâ€, â€œSKIPPEDâ€, â€œKILLEDâ€]:

â€‹ # è·å–æŒ‡å®šFlowçš„å½“å‰çš„æ‰§è¡Œä¿¡æ¯

â€‹ flow_exec = get(az_url + â€œexecutor?â€, data)

â€‹ # ä»è¯¥Flowçš„æ‰§è¡Œä¿¡æ¯ä¸­è·å–nodeså­—æ®µçš„å€¼ï¼Œå¹¶éå†å¯»æ‰¾ç‰¹å®šçš„èŠ‚ç‚¹(job)ä¿¡æ¯ï¼Œè¿›è€Œè·å–è¯¥èŠ‚ç‚¹(job)çš„çŠ¶æ€

â€‹ for node in flow_exec.get(u"nodes"):

â€‹ if unicode(node_id) == node.get(u"id"):

â€‹ status = str(node.get(u"status"))

â€‹ print " ".join([node_id, status])

â€‹ # ç­‰å¾…1sï¼Œè¿›å…¥ä¸‹ä¸€è½®å¾ªç¯åˆ¤æ–­

â€‹ time.sleep(1)

return status == â€œSUCCEEDEDâ€

_2.ODSå±‚è°ƒåº¦è„šæœ¬_

è¯¥è„šæœ¬ç”¨äºæ£€æŸ¥ODSå±‚æ•°æ®è´¨é‡ã€‚

åœ¨Ideaä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶check_ods.pyï¼Œåœ¨æ–‡ä»¶ä¸­ç¼–å†™å¦‚ä¸‹å†…å®¹ï¼š

#!/usr/bin/env python

# -_\- coding: utf-8 -_ -

import sys

import os

from azclient import login,wait_node,get_exec_id

from check_notification import get_yesterday

def check_ods(dt, session_id, exec_id):

â€œâ€"

æ£€æŸ¥ODSå±‚æ•°æ®è´¨é‡

:param dt: æ—¥æœŸ

:param session_id: å’Œazkabané€šè®¯çš„session_id

:param exec_id: æŒ‡å®šçš„æ‰§è¡ŒID

:return: None

â€œâ€"

if wait_node(session_id, exec_id, â€œhdfs_to_ods_dbâ€) and wait_node(session_id,
exec_id, â€œhdfs_to_ods_logâ€):

â€‹ os.system("bash check_ods.sh " + dt)

if **name** == â€˜**main** â€™:

argv = sys.argv

# è·å–session_id

session_id = login()

# è·å–æ‰§è¡ŒIDã€‚åªæœ‰åœ¨åŸFlowæ­£åœ¨æ‰§è¡Œæ—¶æ‰èƒ½è·å–

exec_id = get_exec_id(session_id)

# è·å–æ—¥æœŸï¼Œå¦‚æœä¸å­˜åœ¨å–æ˜¨å¤©

if len(argv) >= 2:

â€‹ dt = argv[1]

else:

â€‹ dt = get_yesterday()

# æ£€æŸ¥å„å±‚æ•°æ®è´¨é‡

if exec_id:

â€‹ check_ods(dt, session_id, exec_id)

_3.DWDå±‚è°ƒåº¦è„šæœ¬_

è¯¥è„šæœ¬ç”¨äºæ£€æŸ¥DWDå±‚æ•°æ®è´¨é‡ã€‚

åœ¨Ideaä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶check_dwd.pyï¼Œåœ¨æ–‡ä»¶ä¸­ç¼–å†™å¦‚ä¸‹å†…å®¹ï¼š

#!/usr/bin/env python

# -_\- coding: utf-8 -_ -

import sys

import os

from azclient import login, wait_node, get_exec_id

from check_notification import get_yesterday

def check_dwd(dt, session_id, exec_id):

â€œâ€"

æ£€æŸ¥DWDå±‚æ•°æ®è´¨é‡

:param dt: æ—¥æœŸ

:param session_id: å’Œazkabané€šè®¯çš„session_id

:param exec_id: æŒ‡å®šçš„æ‰§è¡ŒID

:return: None

â€œâ€"

if wait_node(session_id, exec_id, â€œods_to_dwd_dbâ€) and wait_node(session_id,
exec_id, â€œods_to_dwd_logâ€):

â€‹ os.system("bash check_dwd.sh " + dt)

if **name** == â€˜**main** â€™:

argv = sys.argv

# è·å–session_id

session_id = login()

# è·å–æ‰§è¡ŒIDã€‚åªæœ‰åœ¨åŸFlowæ­£åœ¨æ‰§è¡Œæ—¶æ‰èƒ½è·å–

exec_id = get_exec_id(session_id)

# è·å–æ—¥æœŸï¼Œå¦‚æœä¸å­˜åœ¨å–æ˜¨å¤©

if len(argv) >= 2:

â€‹ dt = argv[1]

else:

â€‹ dt = get_yesterday()

# æ£€æŸ¥å„å±‚æ•°æ®è´¨é‡

if exec_id:

â€‹ check_dwd(dt, session_id, exec_id)

_4.DIMå±‚è°ƒåº¦è„šæœ¬_

è¯¥è„šæœ¬ç”¨äºæ£€æŸ¥DIMå±‚æ•°æ®è´¨é‡ã€‚

åœ¨Ideaä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶check_dim.pyï¼Œåœ¨æ–‡ä»¶ä¸­ç¼–å†™å¦‚ä¸‹å†…å®¹ï¼š

#!/usr/bin/env python

# -_\- coding: utf-8 -_ -

import sys

import os

from azclient import login, wait_node, get_exec_id

from check_notification import get_yesterday

def check_dim(dt, session_id, exec_id):

â€œâ€"

æ£€æŸ¥DIMå±‚æ•°æ®è´¨é‡

:param dt: æ—¥æœŸ

:param session_id: å’Œazkabané€šè®¯çš„session_id

:param exec_id: æŒ‡å®šçš„æ‰§è¡ŒID

:return: None

â€œâ€"

if wait_node(session_id, exec_id, â€œods_to_dim_dbâ€):

â€‹ os.system("bash check_dim.sh " + dt)

if **name** == â€˜**main** â€™:

argv = sys.argv

# è·å–session_id

session_id = login()

# è·å–æ‰§è¡ŒIDã€‚åªæœ‰åœ¨åŸFlowæ­£åœ¨æ‰§è¡Œæ—¶æ‰èƒ½è·å–

exec_id = get_exec_id(session_id)

# è·å–æ—¥æœŸï¼Œå¦‚æœä¸å­˜åœ¨å–æ˜¨å¤©

if len(argv) >= 2:

â€‹ dt = argv[1]

else:

â€‹ dt = get_yesterday()

# æ£€æŸ¥å„å±‚æ•°æ®è´¨é‡

if exec_id:

â€‹ check_dim(dt, session_id, exec_id)

5.Azkabanå·¥ä½œæµé…ç½®æ–‡ä»¶

ï¼ˆ1ï¼‰åœ¨Ideaä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶azkaban.projectï¼Œåœ¨æ–‡ä»¶ä¸­ç¼–å†™å¦‚ä¸‹å†…å®¹ï¼š

azkaban-flow-version: 2.0

ï¼ˆ2ï¼‰åœ¨Ideaä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶data_supervisor.flowï¼Œåœ¨æ–‡ä»¶ä¸­ç¼–å†™å¦‚ä¸‹å†…å®¹ï¼š

nodes:

\- name: check_ods

type: command

config:

command: python check_ods.py ${dt}

\- name: check_dwd

type: command

config:

command: python check_dwd.py ${dt}

\- name: check_dim

type: command

config:

command: python check_dim.py ${dt}

\- name: check_notification

type: command

dependsOn:

â€‹ - check_ods

â€‹ - check_dwd

â€‹ - check_dim

config:

command: python check_notification.py ${alert} ${dt}

ï¼ˆ3ï¼‰å°†æ‰€æœ‰æ–‡ä»¶æ‰“åŒ…æˆdata_supervisor.zipæ–‡ä»¶

![img](https://i-blog.csdnimg.cn/blog_migrate/0c0e9850592531b4e52e0f00a2191201.jpeg)

ï¼ˆ4ï¼‰åœ¨Azkabanæ¡†æ¶ä¸­æ–°å»ºé¡¹ç›®å¹¶ä¸Šä¼ è¯¥æ–‡ä»¶ï¼Œå¯çœ‹åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºå·¥ä½œæµã€‚

![img](https://i-blog.csdnimg.cn/blog_migrate/9d24d30da39330082e009353b6703218.jpeg)

ï¼ˆ5ï¼‰å…ˆå¯åŠ¨æ•°ä»“å·¥ä½œæµï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯åŠ¨è´¨é‡ç›‘æ§å·¥ä½œæµï¼Œå¹¶ä¼ å…¥å¦‚ä¸‹å‚æ•°

![img](https://i-blog.csdnimg.cn/blog_migrate/d8339c7cb27ba495724b8d71650960af.jpeg)

ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè§‚å¯Ÿé‚®ç®±æ˜¯å¦æœ‰å‘Šè­¦é‚®ä»¶

